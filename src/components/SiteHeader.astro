---
interface Props {
  active?: string;
  locale?: 'es' | 'en' | 'fr';
}

const { active = '', locale = 'es' } = Astro.props;
const solutionActive = ['prevencion', 'proteccion', 'asesoriaycapacitacion'].includes(active);
const basePath = locale === 'es' ? '' : `/${locale}`;
const currentPath = Astro.url.pathname || '/';

const pathWithoutLocale = currentPath.replace(/^\/(en|fr)(?=\/|$)/, '') || '/';
const normalizedPath = pathWithoutLocale.endsWith('/') ? pathWithoutLocale : `${pathWithoutLocale}/`;

const copy = {
  es: {
    brandAria: 'Movisafe inicio',
    menuAria: 'Abrir menu',
    navAria: 'Navegacion principal',
    who: 'Quienes Somos',
    clients: 'Nuestros Clientes',
    solutions: 'Nuestras Soluciones',
    prevention: 'Prevencion',
    protection: 'Proteccion',
    advisory: 'Asesoria y Capacitacion',
    team: 'Unase a nuestro equipo',
    news: 'Noticias'
  },
  en: {
    brandAria: 'Movisafe home',
    menuAria: 'Open menu',
    navAria: 'Main navigation',
    who: 'Who We Are',
    clients: 'Our Clients',
    solutions: 'Our Solutions',
    prevention: 'Prevention',
    protection: 'Protection',
    advisory: 'Advisory and Training',
    team: 'Join our team',
    news: 'News'
  },
  fr: {
    brandAria: 'Accueil Movisafe',
    menuAria: 'Ouvrir le menu',
    navAria: 'Navigation principale',
    who: 'Qui Sommes-Nous',
    clients: 'Nos Clients',
    solutions: 'Nos Solutions',
    prevention: 'Prevention',
    protection: 'Protection',
    advisory: 'Conseil et Formation',
    team: 'Rejoignez notre equipe',
    news: 'Actualites'
  }
}[locale];

const localeLabels = {
  es: 'ESP',
  en: 'EN',
  fr: 'FR'
} as const;

const localizedHome = `${basePath}/`;
const localHref = (path: string) => `${basePath}${path}`;

const localizedPagePath = (targetLocale: 'es' | 'en' | 'fr') => {
  const prefix = targetLocale === 'es' ? '' : `/${targetLocale}`;
  return normalizedPath === '/' ? `${prefix}/` : `${prefix}${normalizedPath}`;
};

const localeOptions = (Object.keys(localeLabels) as Array<'es' | 'en' | 'fr'>)
  .filter((code) => code !== locale)
  .map((code) => ({
    code,
    label: localeLabels[code],
    href: localizedPagePath(code)
  }));
---

<header class="site-header site-header--shared" id="top">
  <div class="container nav-wrap">
    <a class="brand" href={localizedHome} aria-label={copy.brandAria}>
      <img src="/images/movisafe/Movisafe-logo-1000x348-v1.0.svg" alt="Movisafe" />
    </a>

    <button class="menu-toggle" type="button" aria-label={copy.menuAria} aria-expanded="false" aria-controls="primary-nav">
      <span></span>
      <span></span>
      <span></span>
    </button>

    <nav id="primary-nav" class="primary-nav" aria-label={copy.navAria}>
      <ul>
        <li class={active === 'quienes-somos' ? 'is-active' : ''}><a href={localHref('/quienes-somos/')}>{copy.who}</a></li>
        <li class={active === 'nuestrosclientes' ? 'is-active' : ''}><a href={localHref('/nuestrosclientes/')}>{copy.clients}</a></li>
        <li class={`has-submenu ${solutionActive ? 'is-active' : ''}`}>
          <button type="button" class="submenu-toggle" aria-expanded="false">{copy.solutions}</button>
          <ul class="submenu">
            <li class={active === 'prevencion' ? 'is-active' : ''}><a href={localHref('/prevencion/')}>{copy.prevention}</a></li>
            <li class={active === 'proteccion' ? 'is-active' : ''}><a href={localHref('/proteccion/')}>{copy.protection}</a></li>
            <li class={active === 'asesoriaycapacitacion' ? 'is-active' : ''}><a href={localHref('/asesoriaycapacitacion/')}>{copy.advisory}</a></li>
          </ul>
        </li>
        <li class={active === 'nuestro-equipo' ? 'is-active' : ''}><a href={localHref('/nuestro-equipo/')}>{copy.team}</a></li>
        <li class={active === 'blog' ? 'is-active' : ''}><a href={localHref('/blog/')}>{copy.news}</a></li>
        <li class="lang-switch lang-dropdown" aria-label="Language selector">
          <button class="lang-trigger" type="button" aria-expanded="false" aria-haspopup="true">
            {localeLabels[locale]}
            <svg viewBox="0 0 20 20" aria-hidden="true" focusable="false">
              <path
                fill-rule="evenodd"
                d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                clip-rule="evenodd"
              ></path>
            </svg>
          </button>
          <ul class="lang-menu" role="menu">
            {localeOptions.map((option) => (
              <li role="none">
                <a href={option.href} role="menuitem">{option.label}</a>
              </li>
            ))}
          </ul>
        </li>
      </ul>
    </nav>
  </div>
</header>

<style>
  .site-header--shared {
    position: sticky;
    top: 0;
    z-index: 50;
    background: color-mix(in srgb, var(--mv-blue) 96%, black);
    box-shadow: 0 8px 20px rgb(0 0 0 / 0.2);
  }

  .site-header--shared .nav-wrap {
    display: grid;
    grid-template-columns: 170px 1fr;
    align-items: center;
    min-height: 78px;
    gap: 1.5rem;
  }

  .site-header--shared .brand img {
    width: 150px;
  }

  .site-header--shared .primary-nav ul {
    margin: 0;
    padding: 0;
    list-style: none;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 1.1rem;
  }

  .site-header--shared .primary-nav a,
  .site-header--shared .submenu-toggle {
    font-size: 0.72rem;
    font-weight: 600;
    letter-spacing: 0.02em;
    color: #ffffff;
    text-transform: uppercase;
    text-decoration: none;
    transition: color 0.2s ease;
    background: none;
    border: 0;
    padding: 0;
    cursor: pointer;
    font-family: inherit;
  }

  .site-header--shared .primary-nav a:hover,
  .site-header--shared .submenu-toggle:hover,
  .site-header--shared li.is-active > a,
  .site-header--shared li.is-active > .submenu-toggle {
    color: #d6e4ff;
  }

  .site-header--shared .has-submenu {
    position: relative;
  }

  .site-header--shared .submenu {
    position: absolute;
    top: calc(100% + 0.45rem);
    left: 50%;
    transform: translateX(-50%);
    min-width: 220px;
    display: grid;
    gap: 0;
    padding: 0.35rem 0;
    background: #0f1f3a;
    border: 1px solid rgb(255 255 255 / 0.2);
    box-shadow: 0 8px 22px rgb(0 0 0 / 0.35);
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s ease;
    z-index: 20;
  }

  .site-header--shared .has-submenu:hover .submenu,
  .site-header--shared .has-submenu.is-open .submenu {
    opacity: 1;
    visibility: visible;
  }

  .site-header--shared .submenu a {
    display: block;
    text-transform: none;
    font-size: 0.78rem;
    padding: 0.45rem 0.8rem;
  }

  .site-header--shared .lang-dropdown {
    position: relative;
  }

  .site-header--shared .lang-trigger {
    display: inline-flex;
    align-items: center;
    gap: 0.2rem;
    border: 0;
    background: none;
    color: #ffffff;
    font: inherit;
    font-size: 0.72rem;
    font-weight: 600;
    letter-spacing: 0.02em;
    text-transform: uppercase;
    cursor: pointer;
    padding: 0;
  }

  .site-header--shared .lang-trigger svg {
    width: 16px;
    height: 16px;
    transition: transform 0.2s ease;
    fill: currentColor;
  }

  .site-header--shared .lang-dropdown.is-open .lang-trigger svg {
    transform: rotate(180deg);
  }

  .site-header--shared .lang-menu {
    position: absolute;
    top: calc(100% + 0.35rem);
    right: 0;
    min-width: 52px;
    list-style: none;
    margin: 0;
    padding: 0.3rem 0;
    border-left: 1px solid rgb(255 255 255 / 0.32);
    background: rgb(5 18 42 / 0.94);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-5px);
    transition: opacity 0.2s ease, transform 0.2s ease;
    z-index: 30;
  }

  .site-header--shared .lang-dropdown.is-open .lang-menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .site-header--shared .lang-menu a {
    display: block;
    padding: 0.2rem 0.55rem;
    font-size: 0.68rem;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    border-left: 1px solid transparent;
  }

  .site-header--shared .lang-menu a:hover {
    border-left-color: rgb(255 255 255 / 0.88);
  }

  .site-header--shared .menu-toggle {
    display: none;
    margin-left: auto;
    border: 0;
    background: none;
    width: 42px;
    height: 42px;
    padding: 0;
    cursor: pointer;
  }

  .site-header--shared .menu-toggle span {
    display: block;
    width: 24px;
    height: 2px;
    margin: 5px auto;
    background: #ffffff;
  }

  @media (max-width: 1080px) {
    .site-header--shared .nav-wrap {
      grid-template-columns: 145px 1fr;
    }

    .site-header--shared .primary-nav ul {
      gap: 0.75rem;
    }

    .site-header--shared .primary-nav a,
    .site-header--shared .submenu-toggle {
      font-size: 0.63rem;
    }
  }

  @media (max-width: 920px) {
    .site-header--shared .menu-toggle {
      display: block;
    }

    .site-header--shared .primary-nav {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--mv-blue);
      border-top: 1px solid rgb(255 255 255 / 0.15);
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .site-header--shared .primary-nav.is-open {
      max-height: 560px;
    }

    .site-header--shared .primary-nav ul {
      flex-direction: column;
      align-items: flex-start;
      gap: 0;
      padding: 0.4rem 0;
    }

    .site-header--shared .primary-nav li {
      width: 100%;
      position: static;
    }

    .site-header--shared .primary-nav a,
    .site-header--shared .submenu-toggle {
      display: block;
      width: 100%;
      text-align: left;
      padding: 0.72rem 1.1rem;
      font-size: 0.72rem;
    }

    .site-header--shared .submenu {
      position: static;
      transform: none;
      min-width: 100%;
      opacity: 1;
      visibility: visible;
      display: none;
      box-shadow: none;
      border: 0;
      background: rgb(255 255 255 / 0.05);
      padding: 0;
    }

    .site-header--shared .has-submenu.is-open .submenu {
      display: block;
    }

    .site-header--shared .submenu a {
      padding-left: 1.9rem;
    }

    .site-header--shared .lang-dropdown {
      padding: 0.52rem 1.1rem 0.92rem;
    }

    .site-header--shared .lang-trigger {
      font-size: 0.72rem;
    }

    .site-header--shared .lang-menu {
      position: static;
      display: none;
      opacity: 1;
      visibility: visible;
      transform: none;
      margin-top: 0.42rem;
      background: rgb(255 255 255 / 0.05);
      border-left: 1px solid rgb(255 255 255 / 0.2);
    }

    .site-header--shared .lang-dropdown.is-open .lang-menu {
      display: block;
    }

    .site-header--shared .lang-menu a {
      width: auto;
      font-size: 0.68rem;
      padding: 0.4rem 0.68rem;
    }
  }
</style>

<script is:inline>
  document.querySelectorAll('.site-header--shared').forEach((header) => {
    const nav = header.querySelector('.primary-nav');
    const toggle = header.querySelector('.menu-toggle');
    const submenuHost = header.querySelector('.has-submenu');
    const submenuToggle = header.querySelector('.submenu-toggle');
    const langHost = header.querySelector('.lang-dropdown');
    const langTrigger = header.querySelector('.lang-trigger');

    if (nav && toggle) {
      toggle.addEventListener('click', () => {
        const open = nav.classList.toggle('is-open');
        toggle.setAttribute('aria-expanded', String(open));
      });

      nav.querySelectorAll('a').forEach((link) => {
        link.addEventListener('click', () => {
          nav.classList.remove('is-open');
          toggle.setAttribute('aria-expanded', 'false');
        });
      });
    }

    if (submenuHost && submenuToggle) {
      submenuToggle.addEventListener('click', () => {
        submenuHost.classList.toggle('is-open');
        submenuToggle.setAttribute('aria-expanded', String(submenuHost.classList.contains('is-open')));
      });
    }

    if (langHost && langTrigger) {
      langTrigger.addEventListener('click', (event) => {
        event.stopPropagation();
        langHost.classList.toggle('is-open');
        langTrigger.setAttribute('aria-expanded', String(langHost.classList.contains('is-open')));
      });

      document.addEventListener('click', (event) => {
        if (!(event.target instanceof Element) || !langHost.contains(event.target)) {
          langHost.classList.remove('is-open');
          langTrigger.setAttribute('aria-expanded', 'false');
        }
      });
    }
  });
</script>
